<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:inline="javascript">
<head>
    <meta charset="UTF-8">
    <title>Create Custom Transaction</title>
    <script type="text/javascript">
        var maxParticipants = [[${members.size()}]];

        function addParticipant() {
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            var currentCount = tableBody.getElementsByTagName("tr").length;
            if (currentCount >= maxParticipants) {
                alert("You cannot add more participants than the number of group members (" + maxParticipants + ").");
                return;
            }

            var templateRow = tableBody.querySelector(".participantRow");
            var newRow = templateRow.cloneNode(true);

            // Clear any input values in the cloned row
            var selects = newRow.getElementsByTagName("select");
            for (var i = 0; i < selects.length; i++) {
                selects[i].selectedIndex = 0;
            }
            var inputs = newRow.getElementsByTagName("input");
            for (var j = 0; j < inputs.length; j++) {
                inputs[j].value = "";
            }

            tableBody.appendChild(newRow);
            updateIndices();
        }

        function removeParticipant(button) {
            var row = button.parentNode.parentNode;
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            if (tableBody.rows.length > 1) {
                tableBody.removeChild(row);
                updateIndices();
            } else {
                alert("At least one participant is required.");
            }
        }

        function updateIndices() {
            var rows = document.querySelectorAll("#participantsTable tbody .participantRow");
            rows.forEach(function(row, index) {
                var select = row.querySelector("select");
                var input = row.querySelector("input[type='number']");
                select.name = "participants[" + index + "].id";
                input.name = "participants[" + index + "].percentage";
            });
        }

        function fillEvenPercentages() {
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            var rows = tableBody.getElementsByTagName("tr");
            var count = rows.length;
            if (count > 0) {
                var evenPercentage = (100 / count).toFixed(2);
                for (var i = 0; i < count; i++) {
                    var input = rows[i].querySelector("input[type='number']");
                    input.value = evenPercentage;
                }
            }
        }

        // Validation function that checks for duplicate participants and verifies sum of percentages
        function validateParticipants() {
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            var selects = tableBody.querySelectorAll("select");
            var selectedIds = [];
            for (var i = 0; i < selects.length; i++) {
                var val = selects[i].value;
                if (selectedIds.indexOf(val) !== -1) {
                    alert("Duplicate participant found. Please ensure each participant is unique.");
                    return false;
                }
                selectedIds.push(val);
            }

            // Sum up percentages
            var inputs = tableBody.querySelectorAll("input[type='number']");
            var sumPercentage = 0;
            for (var j = 0; j < inputs.length; j++) {
                var num = parseFloat(inputs[j].value) || 0;
                sumPercentage += num;
            }

            if (Math.abs(sumPercentage - 100) > 0.1) {
                alert("Total percentage must equal 100. Current total: " + sumPercentage.toFixed(2));
                return false;
            }

            return true;
        }
    </script>
</head>
<body>
<h1>Create Custom Transaction for Group <span th:text="${groupId}"></span></h1>

<form th:action="@{'/groups/' + ${groupId} + '/transactions/create'}" method="post" th:object="${newTransaction}" onsubmit="return validateParticipants();">
    <div>
        <label>Type:</label>
        <select th:field="*{type}">
            <option th:value="${T(cz.cvut.fit.tjv.Navall.models.Transaction.TransactionType).PAYMENT}" th:text="'Payment'"></option>
            <option th:value="${T(cz.cvut.fit.tjv.Navall.models.Transaction.TransactionType).SETTLEMENT}" th:text="'Settlement'"></option>
        </select>
    </div>

    <div>
        <label>Amount:</label>
        <input type="number" step="0.01" th:field="*{amount}" placeholder="Enter amount" required min="0.01" />
    </div>

    <div>
        <label>Paid By:</label>
        <select th:field="*{paidById}">
            <option th:each="member : ${members}" th:value="${member.id}" th:text="${member.name}"></option>
        </select>
    </div>

    <div>
        <h3>Participants</h3>
        <table id="participantsTable" border="1">
            <thead>
            <tr>
                <th>Participant</th>
                <th>Percentage</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr class="participantRow" th:each="participant, iterStat : *{participants}">
                <td>
                    <select th:field="*{participants[__${iterStat.index}__].id}">
                        <option th:each="member : ${members}" th:value="${member.id}" th:text="${member.name}"></option>
                    </select>
                </td>
                <td>
                    <input type="number" step="0.01" th:field="*{participants[__${iterStat.index}__].percentage}" placeholder="Enter percentage" required min="0.01" />
                </td>
                <td>
                    <button type="button" onclick="removeParticipant(this)">Remove</button>
                </td>
            </tr>
            </tbody>
        </table>
        <button type="button" onclick="addParticipant()">Add Participant</button>
        <button type="button" onclick="fillEvenPercentages()">Fill Even Percentages</button>
    </div>

    <div>
        <button type="submit">Create Transaction</button>
    </div>
</form>

<br>
<a th:href="@{'/groups/' + ${groupId}}">Cancel</a>
</body>
</html>
