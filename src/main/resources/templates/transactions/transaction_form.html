<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:inline="javascript">
<head>
    <meta charset="UTF-8">
    <title>Create Custom Transaction</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script type="text/javascript">
        var maxParticipants = [[${members.size()}]];

        function addParticipant() {
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            var currentCount = tableBody.getElementsByTagName("tr").length;
            if (currentCount >= maxParticipants) {
                alert("You cannot add more participants than the number of group members (" + maxParticipants + ").");
                return;
            }

            var templateRow = tableBody.querySelector(".participantRow");
            var newRow = templateRow.cloneNode(true);

            // Clear any input values in the cloned row
            var selects = newRow.getElementsByTagName("select");
            for (var i = 0; i < selects.length; i++) {
                selects[i].selectedIndex = 0;
            }
            var inputs = newRow.getElementsByTagName("input");
            for (var j = 0; j < inputs.length; j++) {
                inputs[j].value = "";
            }

            tableBody.appendChild(newRow);
            updateIndices();
        }

        function removeParticipant(button) {
            var row = button.parentNode.parentNode;
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            if (tableBody.rows.length > 1) {
                tableBody.removeChild(row);
                updateIndices();
            } else {
                alert("At least one participant is required.");
            }
        }

        function updateIndices() {
            var rows = document.querySelectorAll("#participantsTable tbody .participantRow");
            rows.forEach(function(row, index) {
                var select = row.querySelector("select");
                var input = row.querySelector("input[type='number']");
                select.name = "participants[" + index + "].id";
                input.name = "participants[" + index + "].percentage";
            });
        }

        function fillEvenPercentages() {
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            var rows = tableBody.getElementsByTagName("tr");
            var count = rows.length;
            if (count > 0) {
                var evenPercentage = (100 / count).toFixed(2);
                for (var i = 0; i < count; i++) {
                    var input = rows[i].querySelector("input[type='number']");
                    input.value = evenPercentage;
                }
            }
        }

        function validateParticipants() {
            var tableBody = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            var selects = tableBody.querySelectorAll("select");
            var selectedIds = [];
            for (var i = 0; i < selects.length; i++) {
                var val = selects[i].value;
                if (selectedIds.indexOf(val) !== -1) {
                    alert("Duplicate participant found. Please ensure each participant is unique.");
                    return false;
                }
                selectedIds.push(val);
            }

            var inputs = tableBody.querySelectorAll("input[type='number']");
            var sumPercentage = 0;
            for (var j = 0; j < inputs.length; j++) {
                var num = parseFloat(inputs[j].value) || 0;
                sumPercentage += num;
            }

            if (Math.abs(sumPercentage - 100) > 0.1) {
                alert("Total percentage must equal 100. Current total: " + sumPercentage.toFixed(2));
                return false;
            }
            return true;
        }
    </script>
</head>
<body class="bg-gray-50 p-8">
<h1 class="text-3xl font-bold mb-6">
    Create Custom Transaction for Group <span th:text="${groupId}"></span>
</h1>

<form th:action="@{'/groups/' + ${groupId} + '/transactions/create'}"
      method="post"
      th:object="${newTransaction}"
      onsubmit="return validateParticipants();"
      class="max-w-2xl mx-auto space-y-6">
    <div>
        <label class="block font-semibold mb-1">Type:</label>
        <select th:field="*{type}" class="w-full border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option th:value="${T(cz.cvut.fit.tjv.Navall.models.Transaction.TransactionType).PAYMENT}"
                    th:text="'Payment'"></option>
            <option th:value="${T(cz.cvut.fit.tjv.Navall.models.Transaction.TransactionType).SETTLEMENT}"
                    th:text="'Settlement'"></option>
        </select>
    </div>

    <div>
        <label class="block font-semibold mb-1">Amount:</label>
        <input type="number" step="0.01" th:field="*{amount}" placeholder="Enter amount" required min="0.01"
               class="w-full border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"/>
    </div>

    <div>
        <label class="block font-semibold mb-1">Paid By:</label>
        <select th:field="*{paidById}" class="w-full border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option th:each="member : ${members}" th:value="${member.id}" th:text="${member.name}"></option>
        </select>
    </div>

    <div>
        <h3 class="text-xl font-semibold mb-2">Participants</h3>
        <table id="participantsTable" class="min-w-full bg-white border border-gray-200">
            <thead class="bg-gray-100">
            <tr class="text-center">
                <th class="py-2 px-4 border">Participant</th>
                <th class="py-2 px-4 border">Percentage</th>
                <th class="py-2 px-4 border">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr class="participantRow text-center border-t" th:each="participant, iterStat : *{participants}">
                <td class="py-2 px-4">
                    <select th:field="*{participants[__${iterStat.index}__].id}" class="w-full border border-gray-300 p-1 rounded">
                        <option th:each="member : ${members}" th:value="${member.id}" th:text="${member.name}"></option>
                    </select>
                </td>
                <td class="py-2 px-4">
                    <input type="number" step="0.01" th:field="*{participants[__${iterStat.index}__].percentage}" placeholder="Enter percentage" required min="0.01"
                           class="w-full border border-gray-300 p-1 rounded"/>
                </td>
                <td class="py-2 px-4">
                    <button type="button" onclick="removeParticipant(this)"
                            class="bg-red-500 text-white py-1 px-3 rounded hover:bg-red-600">
                        Remove
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <div class="mt-4 space-x-4">
            <button type="button" onclick="addParticipant()"
                    class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                Add Participant
            </button>
            <button type="button" onclick="fillEvenPercentages()"
                    class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600">
                Fill Even Percentages
            </button>
        </div>
    </div>

    <div>
        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
            Create Transaction
        </button>
    </div>
</form>

<br>
<a th:href="@{'/groups/' + ${groupId}}"
   class="block text-blue-500 hover:underline text-center">Cancel</a>
</body>
</html>
